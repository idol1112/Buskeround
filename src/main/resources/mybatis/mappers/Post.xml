<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="post">

	<!-- 공연 시작 -->
	<insert id="live_start" parameterType="Postvo">
		<![CDATA[
			INSERT INTO post (
			    post_no,
			    category_no,
			    user_no,
			    title,
			    latitude,
			    longitude,
			    p_start,
			    live_url,
			    address,
			    p_img
			) VALUES (
			    seq_post_no.NEXTVAL,
			    2,
			    #{user_no},
			    #{title},
			    33.45071802804865,
			    126.57059752230168,
			    sysdate,
			    #{live_url},
			    #{address},
			    'noimg.png'
			)
		]]>
	</insert>

	<!-- 방송상태 On -->
	<update id="live_on" parameterType="PostVo">
		<![CDATA[
			UPDATE users
			SET
			    live = 1
			WHERE
			    user_no = #{user_no}
		]]>
	</update>

	<!-- 공연 종료 -->
	<update id="live_end" parameterType="int">
		<![CDATA[
			UPDATE post
			SET
			    p_end = sysdate
			WHERE
			        user_no = #{user_no}
			    AND p_end IS NULL
		]]>
	</update>

	<!-- 방송상태 Off -->
	<update id="live_off" parameterType="int">
		<![CDATA[
			UPDATE users
			SET
			    live = 0
			WHERE
			    user_no = #{user_no}
		]]>
	</update>

	<!-- 타임라인(메인) 조회 -->
	<select id="timeline_main" parameterType="int" resultType="PostVo">
		<![CDATA[
			SELECT
			    rn,
			    ort.title,
			    to_char(ort.p_start, 'YYYY.MM.DD"("dy")"') p_start,
			    ort.p_img,
			    ort.live_url
			FROM
			    (
			        SELECT
			            ROWNUM rn,
			            ot.title,
			            ot.p_start,
			            ot.p_img,
			            ot.live_url
			        FROM
			            (
			                SELECT
			                    title,
			                    p_start,
			                    p_img,
			                    live_url
			                FROM
			                    post
			                WHERE
			                    user_no = #{user_no}
			                ORDER BY
			                    p_start DESC
			            ) ot
			    ) ort
			WHERE
			        rn >= 1
			    AND rn <= 2
		]]>
	</select>

	<!-- 타임라인 조회 -->
	<select id="timeline" parameterType="map" resultType="PostVo">
		<![CDATA[
	        SELECT
	        	post_no,
	            title,
	            to_char(p_start, 'YYYY.MM.DD"("dy")"') p_start,
	            p_img,
	            live_url
	        FROM
	            post
	        WHERE
	                user_no = #{user_no}
	            AND p_start >= to_char(#{start_date})
	            AND p_start <= to_char(#{end_date})
	        ORDER BY
	            post_no DESC
		]]>
	</select>

	<!-- 썸네일 등록 -->
	<update id="imgInsert" parameterType="PostVo">
		<![CDATA[
			UPDATE post
				SET
				    p_img = #{p_img}
				WHERE
				        user_no = #{user_no}
				    AND p_end IS NULL
		]]>
	</update>

</mapper>